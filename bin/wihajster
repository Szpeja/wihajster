#!/usr/bin/env ruby

require "rubygems"
require "bundler"

require File.expand_path '../../lib/wihajster', __FILE__

Bundler.require(:default, Wihajster.env)
Wihajster.load_libraries

class WihajsterApp
  include Singleton

  include Wihajster
  include Wihajster::Initializers
  include Wihajster::Reloader

  def console(profile="")
    prepare(profile)

    event_loop.run!(:non_block)
    pry self
  end

  def run(profile="")
    prepare(profile)

    event_loop.run!
  end

  def calibrate(profile="")
    prepare(profile)

    # We need to reload event loop so we clear all scripts
    # loaded by a #initialize_event_loop
    event_loop.reload!
    add_event_handler Wihajster::Calibration

    event_loop.run!
  end

  def events_test(profile="")
    prepare(profile)

    # We need to reload event loop so we clear all scripts
    # loaded by a #initialize_event_loop
    event_loop.reload!

    require 'wihajster/calibration/events_test'
    add_event_handler Wihajster::Calibration::EventsTest

    event_loop.run!
  end

  protected

  def prepare
    Wihajster.profile = profile

    enable_reloading

    initialize_rubygame
    initialize_joystick(config.joystick.id)
    initialize_printer(config.printer.device, config.printer.speed)
    initialize_event_loop(profile, config.script.monitor)
  end
end

def start(app)
  action = ARGV[0] || "run"
  methods = app.public_methods(false)
  actions = methods.select{|m| m.to_s.include?(action) }

  if actions.length == 1
    method = actions.first
    begin                                                                                                                                                   
      app.send(method, *ARGV[1..-1])
    rescue ArgumentError => e
      puts "Could not call action #{method} - #{e}"
    end
  else
    puts "Usage: #{__FILE__} [action]"
    puts "\nActions:"
    methods.each do |a| 
      params = 
        app.method(a).parameters.map do |t, arg|
          case t
          when :req then arg.to_s
          when :opt then "[#{arg}]"
          when :rest then "[*#{arg}]"
          end
        end.join(" ")

      puts "  #{a} #{params}"
    end
  end
  
  app
end

start WihajsterApp.instance
